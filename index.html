<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tampilkan "Raw HTML" (Escaped + Render)</title>
  <style>
    /* CSS untuk aplikasi utama */
    :root {
      --bg: #0f1724;
      --card: #0b1220;
      --accent: #7dd3fc;
      --muted: #94a3b8;
      --glass: rgba(255, 255, 255, 0.03);
      --success: #4ade80;
      --danger: #f87171;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', ui-sans-serif, system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      background: linear-gradient(180deg, #071025 0%, #07182a 100%);
      color: #e6eef8;
      line-height: 1.5;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    h1 {
      font-size: 18px;
      margin: 0 0 12px;
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      align-items: start;
    }
    
    .card {
      background: var(--card);
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
      position: relative;
      overflow: hidden;
    }
    
    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    
    textarea {
      width: 100%;
      min-height: 240px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: var(--glass);
      color: inherit;
      font-family: ui-monospace, 'SFMono-Regular', Menlo, Monaco, 'Roboto Mono', monospace;
      font-size: 13px;
      line-height: 1.4;
      resize: vertical;
      transition: border-color 0.2s;
      max-width: 100%;
    }
    
    textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    pre {
      white-space: pre-wrap;
      word-break: break-word;
      padding: 12px;
      border-radius: 8px;
      background: #001627;
      color: #dff6ff;
      overflow: auto;
      max-height: 360px;
      font-family: ui-monospace, 'SFMono-Regular', Menlo, Monaco, 'Roboto Mono', monospace;
      font-size: 13px;
      line-height: 1.4;
      max-width: 100%;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    
    button {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      color: var(--accent);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
      max-width: 100%;
    }
    
    button:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.12);
    }
    
    button:active {
      transform: translateY(1px);
    }
    
    .preview {
      min-height: 240px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
      overflow: auto;
      position: relative;
      max-width: 100%;
      box-sizing: border-box;
    }
    
    .preview-container {
      position: relative;
      max-width: 100%;
    }
    
    .preview-controls {
      position: absolute;
      top: 8px;
      right: 8px;
      z-index: 10;
      display: flex;
      gap: 6px;
    }
    
    .preview-controls button {
      background: rgba(15, 23, 36, 0.8);
      backdrop-filter: blur(4px);
      padding: 6px 10px;
      font-size: 12px;
    }
    
    .foot {
      font-size: 12px;
      color: var(--muted);
      margin-top: 12px;
    }
    
    code {
      font-family: ui-monospace, 'SFMono-Regular', Menlo, Monaco, 'Roboto Mono', monospace;
      background: rgba(255, 255, 255, 0.06);
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 0.9em;
    }
    
    .fullscreen-mode {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1000;
      background: white;
      padding: 20px;
      overflow: auto;
      box-sizing: border-box;
    }
    
    .fullscreen-controls {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 1001;
      display: flex;
      gap: 8px;
    }
    
    .fullscreen-controls button {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      z-index: 1002;
    }
    
    .icon {
      width: 14px;
      height: 14px;
      display: inline-block;
    }
    
    /* Isolasi untuk konten yang di-render */
    #rendered {
      all: initial;
      display: block;
      min-height: 240px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
      overflow: auto;
      max-width: 100%;
      box-sizing: border-box;
    }
    
    #rendered * {
      all: revert;
      box-sizing: border-box;
    }
    
    /* Pencegahan overflow untuk konten yang di-render */
    .rendered-content {
      max-width: 100%;
      overflow-wrap: break-word;
    }
    
    .rendered-content img {
      max-width: 100%;
      height: auto;
    }
    
    .rendered-content table {
      width: 100%;
      max-width: 100%;
      overflow-x: auto;
      display: block;
    }
    
    .rendered-content iframe {
      max-width: 100%;
    }
    
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      body {
        padding: 16px;
      }
      
      .controls {
        flex-direction: column;
      }
      
      button {
        width: 100%;
        justify-content: center;
      }
    }
    
    /* Animasi untuk feedback */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Viewer: tampilkan "raw HTML" dari kode HTML</h1>
    <p class="foot">Gunakan kotak kiri untuk menempel (paste) kode HTML Anda. Klik <em>Show Raw</em> untuk melihat HTML yang sudah di-escape, atau <em>Render</em> untuk melihat hasil render sebenarnya.</p>
    
    <div class="grid">
      <div class="card">
        <label for="source">Kode HTML (raw input)</label>
        <textarea id="source" placeholder="Masukkan kode HTML di sini...">&lt;!doctype html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Contoh&lt;/title&gt;
    &lt;style&gt;
      body { 
        font-family: Arial, sans-serif; 
        margin: 40px; 
        background-color: #f5f5f5;
        color: #333;
      }
      h1 { 
        color: #2563eb; 
        border-bottom: 2px solid #2563eb;
        padding-bottom: 10px;
      }
      .container { 
        max-width: 800px; 
        margin: 0 auto; 
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      table { 
        width: 100%; 
        border-collapse: collapse; 
        margin: 20px 0; 
      }
      table, th, td { 
        border: 1px solid #ddd; 
      }
      th, td { 
        padding: 12px; 
        text-align: left; 
      }
      th {
        background-color: #f0f0f0;
      }
      tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      .btn {
        display: inline-block;
        padding: 8px 16px;
        background: #2563eb;
        color: white;
        border-radius: 4px;
        text-decoration: none;
        margin-top: 10px;
      }
      .btn:hover {
        background: #1d4ed8;
      }
    &lt;/style&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div class="container"&gt;
      &lt;h1&gt;Halo dunia&lt;/h1&gt;
      &lt;p&gt;Ini contoh HTML yang akan ditampilkan sebagai raw atau dirender.&lt;/p&gt;
      
      &lt;button id="demoBtn" class="btn"&gt;Klik Saya!&lt;/button&gt;
      
      &lt;div id="output" style="margin-top: 20px; padding: 10px; background: #f0f9ff; border-radius: 4px; display: none;"&gt;
        Tombol telah diklik! JavaScript berfungsi dengan baik.
      &lt;/div&gt;
      
      &lt;ul&gt;
        &lt;li&gt;Item 1&lt;/li&gt;
        &lt;li&gt;Item 2&lt;/li&gt;
        &lt;li&gt;Item 3&lt;/li&gt;
      &lt;/ul&gt;
      
      &lt;h2&gt;Contoh Tabel&lt;/h2&gt;
      &lt;table&gt;
        &lt;thead&gt;
          &lt;tr&gt;
            &lt;th&gt;Nama&lt;/th&gt;
            &lt;th&gt;Email&lt;/th&gt;
            &lt;th&gt;Peran&lt;/th&gt;
          &lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody&gt;
          &lt;tr&gt;
            &lt;td&gt;John Doe&lt;/td&gt;
            &lt;td&gt;john@example.com&lt;/td&gt;
            &lt;td&gt;Admin&lt;/td&gt;
          &lt;/tr&gt;
          &lt;tr&gt;
            &lt;td&gt;Jane Smith&lt;/td&gt;
            &lt;td&gt;jane@example.com&lt;/td&gt;
            &lt;td&gt;User&lt;/td&gt;
          &lt;/tr&gt;
        &lt;/tbody&gt;
      &lt;/table&gt;
      
      &lt;a href="#" class="btn"&gt;Contoh Tombol&lt;/a&gt;
    &lt;/div&gt;
    
    &lt;script&gt;
      // Script demo untuk menunjukkan JavaScript bekerja
      document.addEventListener('DOMContentLoaded', function() {
        var demoBtn = document.getElementById('demoBtn');
        var output = document.getElementById('output');
        
        if (demoBtn && output) {
          demoBtn.addEventListener('click', function() {
            output.style.display = output.style.display === 'none' ? 'block' : 'none';
          });
        }
      });
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;</textarea>
        
        <div class="controls">
          <button id="btn-raw" title="Tampilkan sebagai teks yang sudah di-escape">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 8a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8z"></path>
              <path d="M10 9h4v6h-4V9z"></path>
            </svg>
            Show Raw
          </button>
          <button id="btn-render" title="Tampilkan sebagai HTML yang dirender">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
            Render
          </button>
          <button id="btn-copy" title="Salin teks raw (escaped) ke clipboard">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            Copy Raw
          </button>
          <button id="btn-download" title="Download file .html dari input">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Download .html
          </button>
        </div>

        <p class="foot">Tip: untuk menampilkan HTML sebagai teks di halaman lain, gunakan fungsi <code>textContent</code> atau escapekan karakter seperti &amp;lt; &amp;gt; &amp;amp;.</p>
      </div>

      <div class="card">
        <label>Raw (escaped) output</label>
        <pre id="raw" class="preview" aria-live="polite"></pre>

        <label style="margin-top: 16px; display: block">Live render</label>
        <div class="preview-container">
          <div id="rendered" class="preview"></div>
          <div class="preview-controls">
            <button id="btn-fullscreen" title="Buka fullscreen">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
              </svg>
            </button>
            <button id="btn-refresh" title="Refresh render">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
/*
  Script untuk:
  - Render HTML into sandboxed iframe (allow-scripts allow-same-origin)
  - Proxy requests from iframe -> parent for wallet interactions via postMessage
  - Support connect_wallet, sign_message, send_transaction (example)
*/

// --- Load ethers.js dynamically if not present ---
(function loadEthersIfNeeded() {
  if (typeof ethers === 'undefined') {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/ethers@6.8.0/dist/ethers.umd.min.js';
    s.onload = () => console.log('ethers.js loaded');
    s.onerror = () => console.warn('Gagal memuat ethers.js dari CDN');
    document.head.appendChild(s);
  }
})();

// --- Element refs (sesuaikan dengan id di HTML) ---
const src = document.getElementById('source');
const raw = document.getElementById('raw');
const rendered = document.getElementById('rendered');
const btnRaw = document.getElementById('btn-raw');
const btnRender = document.getElementById('btn-render');
const btnCopy = document.getElementById('btn-copy');
const btnDownload = document.getElementById('btn-download');
const btnFullscreen = document.getElementById('btn-fullscreen');
const btnRefresh = document.getElementById('btn-refresh');

let currentIframe = null;    // referensi iframe aktif di preview
let fullscreenIframe = null; // referensi iframe di fullscreen (jika ada)
let isFullscreen = false;

// --- Helper: safe postMessage to iframe ---
function postMessageToIframe(iframe, message) {
  if (!iframe || !iframe.contentWindow) return false;
  try {
    iframe.contentWindow.postMessage(message, '*');
    return true;
  } catch (e) {
    console.warn('postMessage failed', e);
    return false;
  }
}

// --- Show raw escaped HTML in <pre> ---
function showRaw() {
  raw.textContent = src.value;
  raw.classList.add('fade-in');
  setTimeout(() => raw.classList.remove('fade-in'), 300);
}

// --- Create & render iframe inside #rendered (sandboxed) ---
function createIframeWithContent(content) {
  // Hapus iframe lama (jika ada)
  if (currentIframe && currentIframe.parentNode) {
    try { currentIframe.parentNode.removeChild(currentIframe); } catch (_) {}
  }

  const iframe = document.createElement('iframe');
  iframe.style.width = '100%';
  iframe.style.height = '420px'; // default height, akan mengikuti container
  iframe.style.border = 'none';
  iframe.style.borderRadius = '8px';
  iframe.style.background = 'white';

  // Gunakan sandbox untuk isolasi tapi izinkan script dan same-origin agar postMessage lebih mudah
  // (iframe tetap tidak dapat mengakses window.ethereum langsung karena sandboxed)
  iframe.sandbox = 'allow-scripts allow-same-origin';

  // Saat iframe siap, tulis dokumen-nya
  iframe.addEventListener('load', () => {
    try {
      const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
      iframeDoc.open();
      // Kami menempelkan konten pengguna di dalam body; pastikan src.value sudah berisi HTML escaped
      iframeDoc.write(`
        <!DOCTYPE html>
        <html>
          <head>
            <base target="_blank">
            <meta charset="utf-8">
          </head>
          <body>
            ${src.value}
            <!-- postMessage helper di sisi iframe: forward pesan dari iframe ke parent apabila dibutuhkan -->
            <script>
              // Pastikan listener tidak didaftarkan berkali-kali
              if (!window.__walletProxyInstalled) {
                window.__walletProxyInstalled = true;

                // Helper untuk kirim request ke parent
                window.walletRequest = function(type, payload) {
                  window.parent.postMessage({ type: type, payload: payload || null }, '*');
                };

                // Terima balasan dari parent
                window.addEventListener('message', function(event) {
                  if (!event.data || typeof event.data !== 'object') return;
                  // dispatch custom event di dalam iframe agar skrip di dalam iframe bisa mendengarkan
                  const ev = new CustomEvent('wallet_proxy', { detail: event.data });
                  window.dispatchEvent(ev);
                });
              }
            <\/script>
          </body>
        </html>
      `);
      iframeDoc.close();
    } catch (e) {
      console.warn('Tulis content ke iframe gagal:', e);
    }
  });

  return iframe;
}

// --- Render function digunakan oleh tombol Render dan Refresh ---
function doRender() {
  // Kosongkan container dan buat iframe baru
  rendered.innerHTML = '';
  const iframe = createIframeWithContent(src.value);

  // Simpan referensi
  currentIframe = iframe;
  rendered.appendChild(iframe);

  // Tambahkan efek visual
  rendered.classList.add('fade-in');
  setTimeout(() => rendered.classList.remove('fade-in'), 300);
}

// --- Fullscreen toggle: buat fullscreen-mode dengan iframe terpisah ---
function toggleFullscreen() {
  if (!isFullscreen) {
    // masuk fullscreen
    isFullscreen = true;

    // buat container fullscreen
    const fs = document.createElement('div');
    fs.className = 'fullscreen-mode';
    fs.style.background = '#fff';
    fs.style.color = '#111';

    // controls
    const controls = document.createElement('div');
    controls.className = 'fullscreen-controls';

    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'Tutup';
    closeBtn.title = 'Tutup fullscreen';
    closeBtn.addEventListener('click', toggleFullscreen);

    controls.appendChild(closeBtn);
    fs.appendChild(controls);

    // buat iframe fullscreen
    const iframe = document.createElement('iframe');
    iframe.style.width = '100%';
    iframe.style.height = 'calc(100% - 60px)';
    iframe.style.border = 'none';
    iframe.style.marginTop = '20px';
    iframe.sandbox = 'allow-scripts allow-same-origin';

    // isi iframe
    iframe.addEventListener('load', () => {
      try {
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        iframeDoc.open();
        iframeDoc.write(`
          <!DOCTYPE html>
          <html>
            <head>
              <base target="_blank">
              <meta charset="utf-8">
            </head>
            <body>
              ${src.value}
              <script>
                if (!window.__walletProxyInstalled) {
                  window.__walletProxyInstalled = true;
                  window.walletRequest = function(type, payload) {
                    window.parent.postMessage({ type: type, payload: payload || null }, '*');
                  };
                  window.addEventListener('message', function(event) {
                    if (!event.data || typeof event.data !== 'object') return;
                    const ev = new CustomEvent('wallet_proxy', { detail: event.data });
                    window.dispatchEvent(ev);
                  });
                }
              <\/script>
            </body>
          </html>
        `);
        iframeDoc.close();
      } catch (e) {
        console.warn('Isi iframe fullscreen gagal', e);
      }
    });

    fs.appendChild(iframe);
    document.body.appendChild(fs);

    // simpan referensi
    fullscreenIframe = iframe;
    currentIframe = iframe;

    // prevent body scroll
    document.body.style.overflow = 'hidden';
  } else {
    // keluar fullscreen
    isFullscreen = false;
    // remove fullscreen element(s)
    const el = document.querySelector('.fullscreen-mode');
    if (el && el.parentNode) el.parentNode.removeChild(el);
    fullscreenIframe = null;
    // restore currentIframe back to preview iframe by re-rendering preview
    doRender();
    document.body.style.overflow = '';
  }
}

// --- Clipboard copy (copy escaped/raw) ---
async function copyRawToClipboard() {
  try {
    // prefer raw.textContent (escaped), fallback ke src.value
    await navigator.clipboard.writeText(raw.textContent || src.value);
    const originalHTML = btnCopy.innerHTML;
    btnCopy.innerHTML = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"></path></svg> Copied ✓';
    btnCopy.style.color = 'var(--success)';
    setTimeout(() => {
      btnCopy.innerHTML = originalHTML;
      btnCopy.style.color = 'var(--accent)';
    }, 1200);
  } catch (err) {
    alert('Gagal menyalin ke clipboard: ' + err);
  }
}

// --- Download file .html dari input ---
function downloadHTML() {
  const blob = new Blob([src.value], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'snippet.html';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// --- Parent: handle messages FROM iframe and proxy to wallet (window.ethereum) ---
window.addEventListener('message', async (event) => {
  // Hanya tangani pesan bila sumbernya adalah currentIframe (jika ada)
  try {
    if (!event.data || typeof event.data !== 'object') return;
    // If currentIframe is set, require event.source === currentIframe.contentWindow
    if (currentIframe && event.source !== currentIframe.contentWindow) {
      // ignore messages from other frames
      return;
    }

    const { type, payload } = event.data;

    // Wait for ethers to be loaded (if not loaded yet)
    if (typeof ethers === 'undefined') {
      // Try to wait small time for CDN load
      await new Promise((res) => setTimeout(res, 200));
    }

    // Utility to send back
    const reply = (msgType, data) => {
      if (currentIframe && currentIframe.contentWindow) {
        currentIframe.contentWindow.postMessage({ type: msgType, payload: data }, '*');
      }
    };

    if (type === 'connect_wallet') {
      if (!window.ethereum) {
        reply('wallet_error', 'Ethereum provider tidak ditemukan pada halaman ini (parent).');
        return;
      }
      try {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        const provider = new ethers.BrowserProvider(window.ethereum);
        const signer = await provider.getSigner();
        const address = await signer.getAddress();
        const network = await provider.getNetwork();
        reply('wallet_connected', { address, chainId: network.chainId, network: network.name });
      } catch (err) {
        reply('wallet_error', err?.message || String(err));
      }
      return;
    }

    if (type === 'sign_message') {
      if (!window.ethereum) {
        reply('wallet_error', 'Ethereum provider tidak ditemukan pada halaman ini (parent).');
        return;
      }
      try {
        const provider = new ethers.BrowserProvider(window.ethereum);
        const signer = await provider.getSigner();
        const message = payload?.message || '';
        const signature = await signer.signMessage(message);
        reply('wallet_signed', { signature, message });
      } catch (err) {
        reply('wallet_error', err?.message || String(err));
      }
      return;
    }

    if (type === 'send_transaction') {
      // payload should include tx: { to, value, data, gasLimit, ... }
      if (!window.ethereum) {
        reply('wallet_error', 'Ethereum provider tidak ditemukan pada halaman ini (parent).');
        return;
      }
      try {
        const provider = new ethers.BrowserProvider(window.ethereum);
        const signer = await provider.getSigner();
        const txRequest = payload?.tx;
        if (!txRequest) throw new Error('Payload tx tidak ditemukan');
        // Send transaction via signer
        const txResponse = await signer.sendTransaction(txRequest);
        // we can wait for one confirmation optionally, or just return tx hash
        reply('tx_submitted', { hash: txResponse.hash });
      } catch (err) {
        reply('wallet_error', err?.message || String(err));
      }
      return;
    }

    // Unknown type -> ignore
  } catch (err) {
    console.warn('Error handling message from iframe', err);
  }
});

// --- Wire up UI events ---
btnRaw.addEventListener('click', () => { showRaw(); src.focus(); });
btnRender.addEventListener('click', () => { doRender(); src.focus(); });
btnCopy.addEventListener('click', copyRawToClipboard);
btnDownload.addEventListener('click', downloadHTML);
btnFullscreen.addEventListener('click', toggleFullscreen);
btnRefresh.addEventListener('click', () => { doRender(); });

// Live preview while typing: update raw immediately but don't re-render iframe on every keystroke (expensive).
src.addEventListener('input', () => {
  showRaw();
});

// Escape key to exit fullscreen
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && isFullscreen) toggleFullscreen();
});

// Initialize UI
showRaw();
doRender();
</script>
</body>
</html>
